## Table of Contents



Initially, ssh-agent allowed loading any shared library without filtering, leading to security concerns. In response to **CVE-2016-10009**, an allow-list (`/usr/lib*/,/usr/local/lib/` by default) was added to limit library loading. However, it is possible to abuse the side effects of the library's constructors (`dlopen`) and destructors (`dlclose`) to manipulate memory and control the program flow.

Code execution can be achieved by making the stack executable, registering a signal handler for `SIGSEGV` and manipulating its code, replacing the signal handler's code with code from another library, triggering a `SIGSEGV`, and replacing his handler's code to finally jump into the stack where the shellcode is stored.

The following paragraphs will present the detailed steps:

1. Making the Stack Executable:  

Leveraging `dlopen()` to load one of the libraries grants the ability to make the stack memory region (specifically the target process `ssh-pkcs11-helper`'s stack) executable. This allows bypassing the usual protection against executing code on the stack.

2. Copy the shellcode to the stack:

Once the shellcode is generated, typically using tools like Metasploit, it can be copied to the stack memory using the socket generated from the SSH connection. The shellcode is also combined with a `NOP sled` which is a sequence of No-Operation assembly instructions. The reason why is to provide a larger target for the program execution flow to land on during the gadget execution.  

To verify whether the process has the desired executable flag, you can use the following commands in dbg, a Linux debugger. You can repeat the next few gdb commands once you have gained access as alice:  

First, obtain the PID of the process `ssh-pkcs11-helper.`
```bash

alice@workstation:~$ ps -aux | grep pkcs11-helperalice 1522 0.0 0.2 7788 5520 ? S 09:22 0:00 /usr/lib/openssh/ssh-pkcs11-helper alice@workstation:~$ sudo gdb -p 1522
```

Using gdb, you can verify whether the stack has the shellcode loaded by inspecting its content.  

Regarding the command `$rsp+10100`, it is an expression that references a specific memory location relative to the stack pointer (`$rsp`). In this case, `$rsp+10100` points to the memory location located 10100 bytes above the stack pointer.  

Observe that it contains a series of NOP (No Operation) instructions followed by the start of the shellcode: `0x31 0xc0 0x48 0x31 0xc0 0xff 0x48`